import React, { useState, useCallback, useEffect, useRef, useMemo } from 'react';
import { SetupPage } from './components/SetupPage';
import { Header } from './components/Header';
import { Footer } from './components/Footer';
import { ResultsDisplay } from './components/ResultsDisplay';
import { LoadingSpinner } from './components/LoadingSpinner';
import { InitialModal } from './components/InitialModal';
import { ApiKeyStatus } from './components/ApiKeyStatus';
import { SettingsModal } from './components/SettingsModal';
import { FreeApiPanel } from './components/FreeApiPanel';
import { ApiConfigModal } from './components/ApiConfigModal';
import UserPanel from './components/UserPanel';
import { hasGeminiApiKey } from './services/apiKeyManager';
import userService from './services/userService';
import type { 
  UserInputs, 
  GeneratedScenario, 
  GeneratedSocialMediaCopy, 
  GeneratedVideoScript, 
  GeneratedImageData, 
  FakeEngagementData, 
  FakeComment,
  GeneratedRealisticItinerary,
  RealisticActivity,
  CoreScene,
  ImageApiProvider,
  TravelReflectionCard,
  ApiConfig,
  ApiServiceStatus,
  UserConfig,
  User,
  UsageLimit
} from './types';
import { 
  generateTravelScenario, 
  generateSocialMediaCopy, 
  generateVideoScript, 
  generateFakeComments,
  generateRealisticTravelItinerary,
  generateRealisticSocialMediaCopy,
  generateRealisticVideoScript,
  generateRealisticFakeComments,
  generateVirtualPhoto,
  generateImageBasedOnReference
} from './services/geminiService';

// å†…ç½®å…è´¹APIæœåŠ¡å¯¼å…¥
import {
  generateBuiltinFreeScenario,
  generateBuiltinFreeItinerary,
  generateBuiltinFreeSocialMediaCopy,
  generateBuiltinFreeVideoScript,
  generateBuiltinFreeImage,
  generateBuiltinFreeImagesByScenes,
  generateBuiltinFreeComments,
  getBuiltinFreeServiceStatus,
  generateTravelReflectionCards,
  generateRealisticImagesByItinerary,
  generateRealisticVideoScriptEnhanced
} from './services/builtinFreeApiService';

import { generateFakeEngagementData } from './services/dataForgeryService';
import { DEFAULT_USER_NAME, FALLBACK_IMAGE_URL, IMAGE_API_PROVIDER_OPTIONS } from './constants';
import { MapGuide } from './components/MapGuide';
import { Settings, Map, User as UserIcon, LogOut, Home, RefreshCw, Sparkles, AlertTriangle } from 'lucide-react';

// å¯¼å…¥æ–°çš„æ™ºèƒ½æ–‡å­—ç”ŸæˆæœåŠ¡
import {
  generateIntelligentScenario,
  generateIntelligentItinerary,
  generateIntelligentSocialMediaCopy,
  generateIntelligentVideoScript
} from './services/textGenerationService';
import { generateIntelligentPhoto } from './services/imageGenerationService';

type AppPhase = 'functionSelection';

/**
 * å¹»å¢ƒä¹‹æ—…ç”Ÿæˆå™¨ä¸»åº”ç”¨ç»„ä»¶
 * ç®¡ç†æ•´ä¸ªåº”ç”¨çš„çŠ¶æ€å’Œç”¨æˆ·æµç¨‹ï¼Œé›†æˆç”¨æˆ·ç³»ç»Ÿ
 */
const App = () => {
  // åº”ç”¨é˜¶æ®µçŠ¶æ€ - åªä¿ç•™åŠŸèƒ½é€‰æ‹©é¡µé¢
  const [currentPhase, setCurrentPhase] = useState<AppPhase>('functionSelection');
  
  // æ·»åŠ é€‰æ‹©çš„æ—…è¡Œæ¨¡å¼çŠ¶æ€
  const [selectedTravelMode, setSelectedTravelMode] = useState<'fictional' | 'realistic' | null>(null);
  
  // ç”¨æˆ·ç³»ç»ŸçŠ¶æ€
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [showUserPanel, setShowUserPanel] = useState(false);
  const [usageInfo, setUsageInfo] = useState<{
    canUse: boolean;
    remainingToday: number;
    nextResetTime: string;
  }>({ canUse: true, remainingToday: 0, nextResetTime: '' });
  
  // ä¸»è¦åº”ç”¨çŠ¶æ€
  const [userInputs, setUserInputs] = useState<UserInputs | null>(null);
  const [generatedScenario, setGeneratedScenario] = useState<GeneratedScenario | null>(null);
  const [generatedItinerary, setGeneratedItinerary] = useState<GeneratedRealisticItinerary | null>(null);
  const [generatedSocialMediaCopy, setGeneratedSocialMediaCopy] = useState<GeneratedSocialMediaCopy | null>(null);
  const [generatedVideoScript, setGeneratedVideoScript] = useState<GeneratedVideoScript | null>(null);
  const [generatedImageData, setGeneratedImageData] = useState<GeneratedImageData | null>(null);
  const [generatedImagesList, setGeneratedImagesList] = useState<GeneratedImageData[]>([]);
  const [fakeEngagementData, setFakeEngagementData] = useState<FakeEngagementData | null>(null);
  const [fakeComments, setFakeComments] = useState<FakeComment[]>([]);
  const [travelReflectionCards, setTravelReflectionCards] = useState<TravelReflectionCard[]>([]);
  
  // UIçŠ¶æ€
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showInitialModal, setShowInitialModal] = useState(false);
  const [showSettingsModal, setShowSettingsModal] = useState(false);
  const [showFreeApiPanel, setShowFreeApiPanel] = useState(false);
  const [showApiConfigModal, setShowApiConfigModal] = useState(false);
  const [showMapGuide, setShowMapGuide] = useState(false);
  const [usingBuiltinFreeApi, setUsingBuiltinFreeApi] = useState(true);

  // APIé…ç½®çŠ¶æ€
  const [apiConfig, setApiConfig] = useState<ApiConfig>({
    textGeneration: {
      enablePaid: false,
      provider: 'builtin_free',
      apiKey: undefined,
      customEndpoint: undefined
    },
    imageGeneration: {
      enablePaid: false,
      provider: 'builtin_free',
      apiKey: undefined,
      customEndpoint: undefined
    },
    global: {
      preferPaidServices: false,
      fallbackToFree: true
    }
  });

  // APIæœåŠ¡çŠ¶æ€
  const [apiServiceStatus, setApiServiceStatus] = useState<ApiServiceStatus>({
    textGeneration: {
      isActive: true,
      provider: 'builtin_free',
      isPaid: false
    },
    imageGeneration: {
      isActive: true,
      provider: 'builtin_free',
      isPaid: false
    }
  });

  // æ·»åŠ é”™è¯¯çŠ¶æ€è¿½è¸ª
  const [appError, setAppError] = useState<string | null>(null);

  // æ·»åŠ ç”Ÿæˆæ­¥éª¤è·Ÿè¸ªçŠ¶æ€
  const [currentGenerationStep, setCurrentGenerationStep] = useState('');
  const [currentStepIndex, setCurrentStepIndex] = useState(0);
  const totalGenerationSteps = 8; // æ€»å…±8ä¸ªç”Ÿæˆæ­¥éª¤

  // æ–°å¢ï¼šæ¯å¼ å›¾ç‰‡çš„åˆ·æ–°é”™è¯¯çŠ¶æ€
  const [refreshError, setRefreshError] = useState<string[]>([]);
  const [refreshingIndexes, setRefreshingIndexes] = useState<number[]>([]);

  // ç”Ÿæˆæ­¥éª¤å®šä¹‰
  const getGenerationSteps = (isVirtual: boolean) => {
    if (isVirtual) {
      return [
        'ğŸ­ æ„æ€è™šæ‹Ÿåœºæ™¯æ¦‚å¿µ',
        'ğŸŒŸ ç”Ÿæˆå¥‡å¹»ä¸–ç•Œè®¾å®š', 
        'ğŸ“± åˆ›ä½œç¤¾äº¤åª’ä½“æ–‡æ¡ˆ',
        'ğŸ¬ ç¼–å†™è§†é¢‘è„šæœ¬åˆ†é•œ',
        'ğŸ¨ ç”Ÿæˆåœºæ™¯é…å›¾',
        'ğŸ’¬ åˆ¶ä½œç”¨æˆ·è¯„è®º',
        'ğŸ“Š è®¡ç®—äº’åŠ¨æ•°æ®',
        'âœ¨ ç”Ÿæˆæ„Ÿè¨€å¡ç‰‡'
      ];
    } else {
      return [
        'ğŸ—ºï¸ åˆ†ææ—…è¡Œç›®çš„åœ°',
        'ğŸ“… åˆ¶å®šè¯¦ç»†è¡Œç¨‹è§„åˆ’',
        'ğŸ“± æ’°å†™æ¨å¹¿æ–‡æ¡ˆ',
        'ğŸ¬ åˆ›å»ºè§†é¢‘è„šæœ¬',
        'ğŸ“· ç”Ÿæˆæ—…è¡Œå›¾ç‰‡',
        'ğŸ’¬ æ¨¡æ‹Ÿç”¨æˆ·åé¦ˆ',
        'ğŸ“ˆ ç»Ÿè®¡äº’åŠ¨æ•°æ®',
        'ğŸ­ åˆ¶ä½œå›å¿†å¡ç‰‡'
      ];
    }
  };

  // æ›´æ–°ç”Ÿæˆæ­¥éª¤çš„è¾…åŠ©å‡½æ•°
  const updateGenerationStep = useCallback((stepIndex: number, isVirtual: boolean = true) => {
    const steps = getGenerationSteps(isVirtual);
    setCurrentStepIndex(stepIndex);
    setCurrentGenerationStep(steps[stepIndex] || 'æ­£åœ¨ç”Ÿæˆå†…å®¹...');
  }, []);

  // é”™è¯¯è¾¹ç•Œå¤„ç†
  useEffect(() => {
    const handleError = (event: ErrorEvent) => {
      console.error('ğŸš¨ åº”ç”¨é”™è¯¯:', event.error);
      setAppError(`åº”ç”¨é”™è¯¯: ${event.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
    };

    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {
      console.error('ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
      setAppError(`Promiseé”™è¯¯: ${event.reason?.message || 'æœªçŸ¥é”™è¯¯'}`);
    };

    window.addEventListener('error', handleError);
    window.addEventListener('unhandledrejection', handleUnhandledRejection);

    return () => {
      window.removeEventListener('error', handleError);
      window.removeEventListener('unhandledrejection', handleUnhandledRejection);
    };
  }, []);

  // è°ƒè¯•å½“å‰çŠ¶æ€
  useEffect(() => {
    console.log('ğŸ” å½“å‰åº”ç”¨çŠ¶æ€:', {
      currentPhase,
      apiConfig,
      apiServiceStatus,
      usingBuiltinFreeApi,
      currentUser,
      usageInfo
    });
  }, [currentPhase, apiConfig, apiServiceStatus, usingBuiltinFreeApi, currentUser, usageInfo]);

  // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
  useEffect(() => {
    const initializeUserSystem = () => {
      // è·å–å½“å‰ç”¨æˆ·
      const user = userService.getCurrentUser();
      setCurrentUser(user);
      
      // æ›´æ–°ä½¿ç”¨æ¬¡æ•°ä¿¡æ¯
      const usage = userService.checkUsageLimit(user?.id);
      setUsageInfo(usage);
      
      console.log('ğŸ”§ ç”¨æˆ·ç³»ç»Ÿåˆå§‹åŒ–:', { user, usage });

      // ğŸ”‘ è‡ªåŠ¨åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
      if (!user || user.tier !== 'admin') {
        console.log('ğŸ”§ æ£€æµ‹åˆ°æ— ç®¡ç†å‘˜è´¦å·ï¼Œæ­£åœ¨åˆ›å»º...');
        userService.createAdminAccount('admin', 'admin@travel-generator.com', 'admin123')
          .then(result => {
            if (result.success && result.user) {
              console.log('âœ… ç®¡ç†å‘˜è´¦å·å·²åˆ›å»ºå¹¶è‡ªåŠ¨ç™»å½•:', {
                username: result.user.username,
                email: result.user.email,
                tier: result.user.tier,
                dailyLimit: '999999'
              });
              setCurrentUser(result.user);
              const newUsage = userService.checkUsageLimit(result.user.id);
              setUsageInfo(newUsage);
            }
          })
          .catch(error => {
            console.error('âŒ ç®¡ç†å‘˜è´¦å·åˆ›å»ºå¤±è´¥:', error);
          });
      }
    };

    initializeUserSystem();
  }, []);

  // æ›´æ–°ä½¿ç”¨æ¬¡æ•°ä¿¡æ¯çš„è¾…åŠ©å‡½æ•°
  const updateUsageInfo = useCallback(() => {
    const usage = userService.checkUsageLimit(currentUser?.id);
    setUsageInfo(usage);
  }, [currentUser]);

  // æ£€æŸ¥å¹¶æ¶ˆè€—ä½¿ç”¨æ¬¡æ•°
  const checkAndConsumeUsage = useCallback((): boolean => {
    const canConsume = userService.consumeUsage(currentUser?.id);
    if (canConsume) {
      updateUsageInfo();
      return true;
    }
    return false;
  }, [currentUser, updateUsageInfo]);

  // å¤„ç†ç”¨æˆ·ç™»å½•/æ³¨å†Œ
  const handleUserChange = useCallback(() => {
    const user = userService.getCurrentUser();
    setCurrentUser(user);
    updateUsageInfo();
  }, [updateUsageInfo]);

  // ä»localStorageåŠ è½½APIé…ç½®
  useEffect(() => {
    const loadApiConfig = () => {
      try {
        const savedConfig = localStorage.getItem('travel-generator-api-config');
        if (savedConfig) {
          const config = JSON.parse(savedConfig);
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ—§æ ¼å¼çš„é…ç½®
          if (config.enablePaidApi !== undefined || config.runningHubApiKey !== undefined) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°æ—§æ ¼å¼APIé…ç½®ï¼Œæ­£åœ¨è¿ç§»...');
            
            // è¿ç§»æ—§æ ¼å¼åˆ°æ–°æ ¼å¼
            const migratedConfig: ApiConfig = {
              textGeneration: {
                enablePaid: false, // æ—§ç‰ˆæœ¬æ²¡æœ‰æ–‡å­—ç”Ÿæˆä»˜è´¹é€‰é¡¹
                provider: 'builtin_free',
                apiKey: undefined,
                customEndpoint: undefined
              },
              imageGeneration: {
                enablePaid: config.enablePaidApi || false,
                provider: config.enablePaidApi ? 'runninghub' : 'builtin_free',
                apiKey: config.runningHubApiKey || undefined,
                customEndpoint: undefined
              },
              global: {
                preferPaidServices: config.enablePaidApi || false,
                fallbackToFree: true
              }
            };
            
            setApiConfig(migratedConfig);
            
            // ä¿å­˜è¿ç§»åçš„é…ç½®
            localStorage.setItem('travel-generator-api-config', JSON.stringify(migratedConfig));
            console.log('âœ… APIé…ç½®è¿ç§»å®Œæˆ');
          } else {
            // æ–°æ ¼å¼é…ç½®ï¼Œä½†éœ€è¦éªŒè¯å®Œæ•´æ€§
            const newConfig: ApiConfig = {
              textGeneration: {
                enablePaid: config.textGeneration?.enablePaid || false,
                provider: config.textGeneration?.provider || 'builtin_free',
                apiKey: config.textGeneration?.apiKey || undefined,
                customEndpoint: config.textGeneration?.customEndpoint || undefined
              },
              imageGeneration: {
                enablePaid: config.imageGeneration?.enablePaid || false,
                provider: config.imageGeneration?.provider || 'builtin_free',
                apiKey: config.imageGeneration?.apiKey || undefined,
                customEndpoint: config.imageGeneration?.customEndpoint || undefined
              },
              global: {
                preferPaidServices: config.global?.preferPaidServices || false,
                fallbackToFree: config.global?.fallbackToFree !== false // é»˜è®¤ä¸ºtrue
              }
            };
            
            setApiConfig(newConfig);
            console.log('âœ… å·²åŠ è½½ä¿å­˜çš„APIé…ç½®');
          }
        }
      } catch (error) {
        console.warn('âš ï¸ åŠ è½½APIé…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
        // å¦‚æœé…ç½®åŠ è½½å¤±è´¥ï¼Œæ¸…é™¤æŸåçš„é…ç½®å¹¶ä½¿ç”¨é»˜è®¤å€¼
        localStorage.removeItem('travel-generator-api-config');
      }
    };
    
    loadApiConfig();
  }, []);

  // ä¿å­˜APIé…ç½®åˆ°localStorage
  const saveApiConfig = useCallback((config: ApiConfig) => {
    try {
      console.log('ğŸ’¾ å¼€å§‹ä¿å­˜APIé…ç½®:', config);
      localStorage.setItem('travel-generator-api-config', JSON.stringify(config));
      setApiConfig(config);
      console.log('âœ… APIé…ç½®å·²ä¿å­˜åˆ°localStorage');
      console.log('ğŸ” ä¿å­˜åçš„é…ç½®è¯¦æƒ…:');
      console.log('ğŸ“ æ–‡å­—ç”ŸæˆæœåŠ¡:', {
        å¯ç”¨ä»˜è´¹: config.textGeneration.enablePaid,
        æä¾›å•†: config.textGeneration.provider,
        æœ‰APIå¯†é’¥: !!config.textGeneration.apiKey
      });
      console.log('ğŸ¨ å›¾åƒç”ŸæˆæœåŠ¡:', {
        å¯ç”¨ä»˜è´¹: config.imageGeneration.enablePaid,
        æä¾›å•†: config.imageGeneration.provider,
        æœ‰APIå¯†é’¥: !!config.imageGeneration.apiKey
      });
    } catch (error) {
      console.error('âŒ ä¿å­˜APIé…ç½®å¤±è´¥:', error);
    }
  }, []);

  // åˆå§‹åŒ–æ—¶æ£€æŸ¥APIé…ç½®çŠ¶æ€
  useEffect(() => {
    const checkApiStatus = () => {
      console.log('ğŸ”§ å¼€å§‹æ£€æŸ¥APIæœåŠ¡çŠ¶æ€...');
      console.log('ğŸ” å½“å‰é…ç½®:', apiConfig);
      
      // æ›´æ–°æ–‡å­—ç”ŸæˆæœåŠ¡çŠ¶æ€
      const textStatus = {
        isActive: true,
        provider: apiConfig.textGeneration.provider,
        isPaid: apiConfig.textGeneration.enablePaid && apiConfig.textGeneration.provider !== 'builtin_free'
      };

      // æ›´æ–°å›¾åƒç”ŸæˆæœåŠ¡çŠ¶æ€
      const imageStatus = {
        isActive: true,
        provider: apiConfig.imageGeneration.provider,
        isPaid: apiConfig.imageGeneration.enablePaid && apiConfig.imageGeneration.provider !== 'builtin_free'
      };

      console.log('ğŸ“ æ–‡å­—ç”ŸæˆçŠ¶æ€è®¡ç®—:');
      console.log('  - enablePaid:', apiConfig.textGeneration.enablePaid);
      console.log('  - provider:', apiConfig.textGeneration.provider);
      console.log('  - provider !== builtin_free:', apiConfig.textGeneration.provider !== 'builtin_free');
      console.log('  - æœ€ç»ˆisPaid:', textStatus.isPaid);

      console.log('ğŸ¨ å›¾åƒç”ŸæˆçŠ¶æ€è®¡ç®—:');
      console.log('  - enablePaid:', apiConfig.imageGeneration.enablePaid);
      console.log('  - provider:', apiConfig.imageGeneration.provider);
      console.log('  - provider !== builtin_free:', apiConfig.imageGeneration.provider !== 'builtin_free');
      console.log('  - æœ€ç»ˆisPaid:', imageStatus.isPaid);

      setApiServiceStatus({
        textGeneration: textStatus,
        imageGeneration: imageStatus
      });

      // æ›´æ–°æ—§çš„å…¼å®¹æ€§çŠ¶æ€
      const hasAnyPaidService = textStatus.isPaid || imageStatus.isPaid;
      setUsingBuiltinFreeApi(!hasAnyPaidService);

      console.log('ğŸ”§ APIæœåŠ¡çŠ¶æ€æ›´æ–°å®Œæˆ:');
      console.log('ğŸ“ æ–‡å­—ç”Ÿæˆ:', textStatus.isPaid ? `ğŸ’ ${textStatus.provider}` : `ğŸ†“ ${textStatus.provider}`);
      console.log('ğŸ¨ å›¾åƒç”Ÿæˆ:', imageStatus.isPaid ? `ğŸ’ ${imageStatus.provider}` : `ğŸ†“ ${imageStatus.provider}`);
      console.log('ğŸ“Š çŠ¶æ€æ€»ç»“:', { textStatus, imageStatus, hasAnyPaidService });
    };
    
    checkApiStatus();
  }, [apiConfig]);

  // é‡ç½®æ‰€æœ‰çŠ¶æ€
  const handleReset = useCallback(() => {
    setUserInputs(null);
    setGeneratedScenario(null);
    setGeneratedItinerary(null);
    setGeneratedSocialMediaCopy(null);
    setGeneratedVideoScript(null);
    setGeneratedImageData(null);
    setGeneratedImagesList([]);
    setFakeEngagementData(null);
    setFakeComments([]);
    setError(null);
    setTravelReflectionCards([]);
  }, []);

  /**
   * è¿”å›é¦–é¡µå‡½æ•°
   * æ¸…ç†æ‰€æœ‰çŠ¶æ€å¹¶è¿”å›åˆ°åŠŸèƒ½é€‰æ‹©é¡µé¢
   */
  const handleBackToHome = useCallback(() => {
    setSelectedTravelMode(null);
    setShowInitialModal(false);
    handleReset();
    setCurrentPhase('functionSelection');
  }, [handleReset]);

  /**
   * é‡æ–°è®¾ç½®æ—…ç¨‹å‡½æ•°
   * ä¿ç•™æ—…è¡Œæ¨¡å¼ä½†æ¸…ç†ç”Ÿæˆçš„å†…å®¹ï¼Œé‡æ–°æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
   */
  const handleBackToSetup = useCallback(() => {
    handleReset();
    if (selectedTravelMode) {
      setShowInitialModal(true);
    }
  }, [handleReset, selectedTravelMode]);

  /**
   * é€€å‡ºåº”ç”¨å‡½æ•°
   * æ¸…ç†æ‰€æœ‰çŠ¶æ€å¹¶å…³é—­æˆ–åˆ·æ–°é¡µé¢
   */
  const handleExitApp = useCallback(() => {
    // æ¸…ç†æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸´æ—¶æ•°æ®
    try {
      localStorage.removeItem('temp-generation-data');
      sessionStorage.clear();
    } catch (error) {
      console.warn('æ¸…ç†å­˜å‚¨æ•°æ®æ—¶å‡ºé”™:', error);
    }
    
    // é‡ç½®æ‰€æœ‰çŠ¶æ€
    handleReset();
    setSelectedTravelMode(null);
    setShowInitialModal(false);
    setCurrentPhase('functionSelection');
    
    // å¦‚æœæ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œå°è¯•å…³é—­çª—å£æˆ–è¿”å›ä¸Šä¸€é¡µ
    if (typeof window !== 'undefined') {
      // å¦‚æœçª—å£æ˜¯é€šè¿‡è„šæœ¬æ‰“å¼€çš„ï¼Œå¯ä»¥å…³é—­
      if (window.opener) {
        window.close();
      } else {
        // å¦åˆ™è¿”å›ä¸Šä¸€é¡µæˆ–åˆ·æ–°é¡µé¢
        if (window.history.length > 1) {
          window.history.back();
        } else {
          // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œåˆ·æ–°åˆ°é¦–é¡µ
          window.location.reload();
        }
      }
    }
  }, [handleReset]);

  // é˜¶æ®µè½¬æ¢å¤„ç†å‡½æ•°
  const handleFunctionSelect = (functionType: 'virtual' | 'real') => {
    // è®¾ç½®é€‰æ‹©çš„æ—…è¡Œæ¨¡å¼
    const travelMode = functionType === 'virtual' ? 'fictional' : 'realistic';
    setSelectedTravelMode(travelMode);
    
    // ç›´æ¥æ‰“å¼€é…ç½®æ¨¡æ€æ¡†
    setShowInitialModal(true);
  };

  const handleBackToFunctionSelection = () => {
    // æ¸…ç†çŠ¶æ€
    setSelectedTravelMode(null);
    handleReset();
  };

  const handleBackToWelcome = () => {
    // æ¸…ç†çŠ¶æ€
    setSelectedTravelMode(null);
    handleReset();
  };

  // å¼€å§‹ç”Ÿæˆæ—…è¡Œå†…å®¹
  const handleStartGeneration = () => {
    setShowInitialModal(true);
  };

  const handleInputSubmit = async (inputs: UserInputs) => {
    console.log('ğŸš€ å¼€å§‹ç”Ÿæˆå†…å®¹ï¼Œè¾“å…¥å‚æ•°ï¼š', inputs);
    
    // æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°é™åˆ¶
    if (!usageInfo.canUse) {
      setError(`ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™ã€‚${currentUser ? 'è¯·å‡çº§ä¼šå‘˜æˆ–æ˜æ—¥å†è¯•' : 'è¯·ç™»å½•è´¦å·æˆ–å‡çº§ä¼šå‘˜è·å¾—æ›´å¤šæ¬¡æ•°'}`);
      return;
    }

    // æ¶ˆè€—ä½¿ç”¨æ¬¡æ•°
    if (!checkAndConsumeUsage()) {
      setError('ä½¿ç”¨æ¬¡æ•°ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹');
      return;
    }

    setIsLoading(true);
    setError(null);
    setAppError(null);
    setUserInputs(inputs);
    
    // é‡ç½®æ‰€æœ‰ç”Ÿæˆç»“æœ
    setGeneratedScenario(null);
    setGeneratedItinerary(null);
    setGeneratedSocialMediaCopy(null);
    setGeneratedVideoScript(null);
    setGeneratedImageData(null);
    setGeneratedImagesList([]);
    setFakeEngagementData(null);
    setFakeComments([]);
    setTravelReflectionCards([]);

    try {
      setIsLoading(true);
      setCurrentStepIndex(0);
      setError(null);

      // æ ¹æ®APIé…ç½®é€‰æ‹©ç”Ÿæˆæ–¹å¼
      const config = apiConfig;
      const hasApiKey = config?.textGeneration?.enablePaid && config?.textGeneration?.apiKey;
      
      if (hasApiKey) {
        console.log('ğŸš€ ä½¿ç”¨æ™ºèƒ½APIç”Ÿæˆå†…å®¹...');
        await generateContentWithBuiltinFreeApi(inputs); // æš‚æ—¶ä½¿ç”¨å†…ç½®æœåŠ¡ï¼Œå› ä¸ºæ™ºèƒ½æœåŠ¡è¿˜åœ¨å¼€å‘ä¸­
      } else {
        console.log('ğŸ†“ ä½¿ç”¨å†…ç½®å…è´¹APIç”Ÿæˆå†…å®¹...');
        await generateContentWithBuiltinFreeApi(inputs);
      }

      setIsLoading(false);
      setCurrentStepIndex(0);
    } catch (error: any) {
      console.error('âŒ å†…å®¹ç”Ÿæˆå¤±è´¥:', error);
      setError(error.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯');
      setAppError(error.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯');
      setIsLoading(false);
      setCurrentStepIndex(0);
    }
  };

  // ç”Ÿæˆæ¨¡æ‹Ÿç”¨æˆ·äº¤äº’æ•°æ®
  const generateFakeEngagementData = (destinationName: string, isRealistic: boolean): FakeEngagementData => {
    const baseViews = isRealistic ? 50000 : 80000;
    const viewVariation = Math.random() * 100000;
    const totalViews = Math.floor(baseViews + viewVariation);
    const totalReads = Math.floor(totalViews * 1.2); // é˜…è¯»é‡é€šå¸¸é«˜äºæ’­æ”¾é‡
    
    return {
      reads: `${(totalReads / 10000).toFixed(1)}ä¸‡`,
      collections: `${Math.floor(totalReads * (0.03 + Math.random() * 0.07))}`, // 3-10% æ”¶è—ç‡
      likeRate: `${((0.08 + Math.random() * 0.12) * 100).toFixed(1)}%`, // 8-20% ç‚¹èµç‡
      completionRate: `${((0.60 + Math.random() * 0.30) * 100).toFixed(1)}%` // 60-90% å®Œæˆç‡
    };
  };

  // ä½¿ç”¨å†…ç½®å…è´¹APIç”Ÿæˆå†…å®¹
  const generateContentWithBuiltinFreeApi = async (inputs: UserInputs) => {
    console.log('ğŸ†“ ä½¿ç”¨å†…ç½®å…è´¹APIå¼€å§‹ç”Ÿæˆ...');
    const isVirtual = inputs.travelMode === 'fictional';
    
    if (inputs.travelMode === 'fictional') {
      // è™šæ‹Ÿåœºæ™¯æ¨¡å¼
      updateGenerationStep(0, true);
      console.log('ğŸ­ ç”Ÿæˆè™šæ‹Ÿåœºæ™¯...');
      await new Promise(resolve => setTimeout(resolve, 1500)); // æ¨¡æ‹ŸåŠ è½½æ—¶é—´
      
      updateGenerationStep(1, true);
      const scenario = await generateIntelligentScenario(inputs);
      setGeneratedScenario(scenario);

      // ç”Ÿæˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆ
      updateGenerationStep(2, true);
      console.log('ğŸ“± ç”Ÿæˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆ...');
      await new Promise(resolve => setTimeout(resolve, 1000));
      const socialMediaCopy = await generateIntelligentSocialMediaCopy(
        scenario,
        null,
        inputs
      );
      setGeneratedSocialMediaCopy(socialMediaCopy);

      // ç”Ÿæˆè§†é¢‘è„šæœ¬
      updateGenerationStep(3, true);
      console.log('ğŸ¬ ç”Ÿæˆè§†é¢‘è„šæœ¬...');
      await new Promise(resolve => setTimeout(resolve, 1500));
      const videoScript = await generateIntelligentVideoScript(
        scenario,
        null,
        inputs,
        Date.now() + Math.floor(Math.random() * 100000)
      );
      setGeneratedVideoScript(videoScript);

      // ç”Ÿæˆè¯„è®º
      updateGenerationStep(5, true);
      console.log('ğŸ’¬ ç”Ÿæˆè¯„è®º...');
      await new Promise(resolve => setTimeout(resolve, 800));
      const comments = await generateBuiltinFreeComments(
        scenario,
        null,
        inputs
      );
      setFakeComments(comments);

      // ç”Ÿæˆæ¨¡æ‹Ÿäº¤äº’æ•°æ®
      updateGenerationStep(6, true);
      console.log('ğŸ“Š ç”Ÿæˆæ¨¡æ‹Ÿäº¤äº’æ•°æ®...');
      await new Promise(resolve => setTimeout(resolve, 500));
      const engagementData = generateFakeEngagementData(scenario.destinationName, false);
      setFakeEngagementData(engagementData);

      // ç”Ÿæˆæ—…è¡Œæ„Ÿè¨€å¡ç‰‡
      updateGenerationStep(7, true);
      console.log('ğŸ¨ å¼€å§‹ç”Ÿæˆæ—…è¡Œæ„Ÿè¨€å¡ç‰‡...');
      await new Promise(resolve => setTimeout(resolve, 1000));
      try {
        const reflectionCards = await generateTravelReflectionCards(
          scenario,
          null,
          inputs
        );
        setTravelReflectionCards(reflectionCards);
        console.log(`âœ… æˆåŠŸç”Ÿæˆ ${reflectionCards.length} å¼ æ„Ÿè¨€å¡ç‰‡`);
      } catch (error) {
        console.warn('âš ï¸ æ„Ÿè¨€å¡ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­å…¶ä»–æµç¨‹:', error);
        setTravelReflectionCards([]);
      }

      // ç”Ÿæˆå›¾ç‰‡ - ä½¿ç”¨æ–°çš„åˆ†é•œå¯¹åº”å›¾ç‰‡ç”Ÿæˆå‡½æ•°
      updateGenerationStep(4, true);
      console.log('ğŸ¨ ç”Ÿæˆè™šæ‹Ÿåœºæ™¯å›¾ç‰‡ï¼ˆä¸è§†é¢‘åˆ†é•œä¸€ä¸€å¯¹åº”ï¼‰...');
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // å¯¼å…¥æ–°çš„å›¾ç‰‡ç”Ÿæˆå‡½æ•°
      const { generateImagesByVideoScenes } = await import('./services/builtinFreeApiService');
      
      // ä½¿ç”¨è§†é¢‘åˆ†é•œç”Ÿæˆå¯¹åº”æ•°é‡çš„å›¾ç‰‡
      const geminiVirtualImages = await generateImagesByVideoScenes(
        videoScript,
        scenario,
        null,
        inputs
      );
      
      // è®¾ç½®å›¾ç‰‡æ•°æ®
      setGeneratedImageData(geminiVirtualImages[0] || null);
      setGeneratedImagesList(geminiVirtualImages);
      console.log(`âœ… è™šæ‹Ÿåœºæ™¯å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼å…±ç”Ÿæˆ${geminiVirtualImages.length}å¼ å›¾ç‰‡`);
      console.log('ğŸ¯ å›¾ç‰‡åœºæ™¯åˆ—è¡¨:', geminiVirtualImages.map(img => img.sceneName));
      console.log('ğŸ¬ è§†é¢‘åˆ†é•œæ•°é‡:', videoScript.scenes.length);
      console.log('ğŸ“Š å›¾ç‰‡ä¸è§†é¢‘åˆ†é•œæ•°é‡å¯¹æ¯”:', geminiVirtualImages.length === videoScript.scenes.length ? 'âœ… å®Œå…¨ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´');

    } else {
      // çœŸå®æ—…è¡Œæ¨¡å¼
      updateGenerationStep(0, false);
      console.log('ğŸ—ºï¸ ç”ŸæˆçœŸå®æ—…è¡Œè®¡åˆ’...');
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      updateGenerationStep(1, false);
      const itinerary = await generateIntelligentItinerary(inputs);
      setGeneratedItinerary(itinerary);

      // ç”Ÿæˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆ
      updateGenerationStep(2, false);
      console.log('ğŸ“± ç”ŸæˆçœŸå®æ—…è¡Œç¤¾äº¤åª’ä½“æ–‡æ¡ˆ...');
      await new Promise(resolve => setTimeout(resolve, 1000));
      const socialMediaCopy = await generateIntelligentSocialMediaCopy(
        null,
        itinerary,
        inputs
      );
      setGeneratedSocialMediaCopy(socialMediaCopy);

      // ç”Ÿæˆè§†é¢‘è„šæœ¬
      updateGenerationStep(3, false);
      console.log('ğŸ¬ ç”ŸæˆçœŸå®æ—…è¡Œå¢å¼ºç‰ˆè§†é¢‘è„šæœ¬...');
      await new Promise(resolve => setTimeout(resolve, 1500));
      const videoScript = await generateIntelligentVideoScript(
        null,
        itinerary,
        inputs,
        Date.now() + Math.floor(Math.random() * 100000)
      );
      setGeneratedVideoScript(videoScript);

      // ç”Ÿæˆè¯„è®º
      updateGenerationStep(5, false);
      console.log('ğŸ’¬ ç”ŸæˆçœŸå®æ—…è¡Œè¯„è®º...');
      await new Promise(resolve => setTimeout(resolve, 800));
      const comments = await generateBuiltinFreeComments(
        null,
        itinerary,
        inputs
      );
      setFakeComments(comments);

      // ä½¿ç”¨æ–°çš„åˆ†é•œå¯¹åº”å›¾ç‰‡ç”Ÿæˆå‡½æ•°
      updateGenerationStep(4, false);
      console.log('ğŸ¨ ç”ŸæˆçœŸå®æ—…è¡Œå›¾ç‰‡ï¼ˆä¸è§†é¢‘åˆ†é•œä¸€ä¸€å¯¹åº”ï¼‰...');
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // å¯¼å…¥æ–°çš„å›¾ç‰‡ç”Ÿæˆå‡½æ•°
      const { generateImagesByVideoScenes } = await import('./services/builtinFreeApiService');
      
      // ä½¿ç”¨è§†é¢‘åˆ†é•œç”Ÿæˆå¯¹åº”æ•°é‡çš„å›¾ç‰‡
      const geminiRealisticImages = await generateImagesByVideoScenes(
        videoScript,
        null,
        itinerary,
        inputs
      );
      
      // è®¾ç½®å›¾ç‰‡æ•°æ®
      setGeneratedImageData(geminiRealisticImages[0] || null); // ä¸»å›¾ç‰‡
      setGeneratedImagesList(geminiRealisticImages); // æ‰€æœ‰å›¾ç‰‡åˆ—è¡¨
      
      console.log(`âœ… çœŸå®æ—…è¡Œå›¾ç‰‡ç”Ÿæˆå®Œæˆï¼å…±ç”Ÿæˆ${geminiRealisticImages.length}å¼ å›¾ç‰‡`);
      console.log('ğŸ¯ å›¾ç‰‡åœºæ™¯åˆ—è¡¨:', geminiRealisticImages.map(img => img.sceneName));
      console.log('ğŸ¬ è§†é¢‘åˆ†é•œæ•°é‡:', videoScript.scenes.length);
      console.log('ğŸ“Š å›¾ç‰‡ä¸è§†é¢‘åˆ†é•œæ•°é‡å¯¹æ¯”:', geminiRealisticImages.length === videoScript.scenes.length ? 'âœ… å®Œå…¨ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´');

      // ç”Ÿæˆæ¨¡æ‹Ÿäº¤äº’æ•°æ®
      updateGenerationStep(6, false);
      console.log('ğŸ“Š ç”Ÿæˆæ¨¡æ‹Ÿäº¤äº’æ•°æ®...');
      await new Promise(resolve => setTimeout(resolve, 500));
      const engagementData = generateFakeEngagementData(itinerary.destinationName, true);
      setFakeEngagementData(engagementData);

      // ç”Ÿæˆæ—…è¡Œæ„Ÿè¨€å¡ç‰‡
      updateGenerationStep(7, false);
      console.log('âœ¨ ç”Ÿæˆæ—…è¡Œæ„Ÿè¨€å¡ç‰‡...');
      await new Promise(resolve => setTimeout(resolve, 1000));
      try {
        const reflectionCards = await generateTravelReflectionCards(
          null,
          itinerary,
          inputs
        );
        setTravelReflectionCards(reflectionCards);
        console.log(`âœ… æˆåŠŸç”Ÿæˆ ${reflectionCards.length} å¼ æ„Ÿè¨€å¡ç‰‡`);
      } catch (error) {
        console.warn('âš ï¸ æ„Ÿè¨€å¡ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­å…¶ä»–æµç¨‹:', error);
        setTravelReflectionCards([]);
      }
    }

    console.log('âœ… å†…ç½®å…è´¹APIç”Ÿæˆå®Œæˆï¼');
    setIsLoading(false);
  };

  // ä½¿ç”¨Gemini APIç”Ÿæˆå†…å®¹ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
  const generateContentWithGeminiApi = async (inputs: UserInputs) => {
    if (inputs.travelMode === 'fictional') {
      // è™šæ‹Ÿåœºæ™¯æ¨¡å¼
      console.log('ğŸ­ ç”Ÿæˆè™šæ‹Ÿåœºæ™¯...');
      const scenario = await generateTravelScenario(
        inputs.theme,
        inputs.duration,
        inputs.persona,
        inputs.customDestination
      );
      setGeneratedScenario(scenario);

      // ç”Ÿæˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆ
      console.log('ğŸ“± ç”Ÿæˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆ...');
      const socialMediaCopy = await generateSocialMediaCopy(
        scenario.destinationName,
        scenario.coreScenes[0],
        scenario.plotHook || '',
        inputs.duration
      );
      setGeneratedSocialMediaCopy(socialMediaCopy);

      // ç”Ÿæˆè§†é¢‘è„šæœ¬
      console.log('ğŸ¬ ç”Ÿæˆè§†é¢‘è„šæœ¬...');
      const videoScript = await generateVideoScript(
        scenario.destinationName,
        scenario.coreScenes[0],
        inputs.duration,
        inputs.theme,
        inputs.uploadedImageBase64,
        inputs.uploadedImageMimeType
      );
      setGeneratedVideoScript(videoScript);

      // ç”Ÿæˆè¯„è®º
      console.log('ğŸ’¬ ç”Ÿæˆè¯„è®º...');
      const comments = await generateFakeComments(
        scenario.destinationName,
        scenario.coreScenes[0].name,
        scenario.coreScenes[0].description
      );
      const formattedComments: FakeComment[] = comments.map((comment, index) => ({
        id: `comment-${index}`,
        userName: `ç”¨æˆ·${index + 1}`,
        content: comment,
        timestamp: new Date(Date.now() - Math.random() * 86400000).toISOString()
      }));
      setFakeComments(formattedComments);

      // ç”Ÿæˆå›¾ç‰‡ - ä½¿ç”¨å†…ç½®å…è´¹æœåŠ¡
      console.log('ğŸ¨ ç”Ÿæˆå›¾ç‰‡...');
      const imagePrompt = scenario.coreScenes[0].visualPromptHint || 
        `${scenario.destinationName}çš„${scenario.coreScenes[0].name}`;
      
      // ğŸ¯ é‡è¦ä¿®å¤ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸Šä¼ äº†å›¾ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨å›¾ç”Ÿå›¾æ¨¡å¼
      const hasUploadedImage = !!inputs.uploadedImageBase64;
      console.log(`ğŸ–¼ï¸ ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡æ£€æŸ¥: ${hasUploadedImage ? 'âœ… æœ‰ä¸Šä¼ ' : 'âŒ æ— ä¸Šä¼ '}`);
      
      if (hasUploadedImage && inputs.uploadedImageBase64) {
        console.log('ğŸ–¼ï¸ ä½¿ç”¨å›¾ç”Ÿå›¾æ¨¡å¼ï¼ˆèåˆç”¨æˆ·ç…§ç‰‡ï¼‰');
        const enhancedImagePrompt = `åŸºäºç”¨æˆ·ä¸Šä¼ çš„ä¸ªäººç…§ç‰‡ï¼Œå°†å…¶è½¬æ¢ä¸º${scenario.destinationName}çš„${scenario.coreScenes[0].name}åœºæ™¯ã€‚ä¿æŒäººç‰©ç‰¹å¾ï¼Œæ›¿æ¢èƒŒæ™¯ä¸ºè™šæ‹Ÿå¹»å¢ƒã€‚${imagePrompt}`;
        
        const result = await generateIntelligentPhoto(
          enhancedImagePrompt, 
          inputs.filterStyle,
          false, // è™šæ‹Ÿé£æ ¼
          inputs.uploadedImageBase64,
          inputs.uploadedImageMimeType
        );
        
        return {
          imageBase64: result.imageBase64,
          promptUsed: result.promptUsed,
          apiProvider: result.apiProvider as ImageApiProvider,
          sceneName: scenario.coreScenes[0].name,
          filterApplied: inputs.filterStyle,
          fictionalPlace: scenario.destinationName
        };
      } else {
        console.log('ğŸ“ ä½¿ç”¨æ ‡å‡†æ–‡ç”Ÿå›¾æ¨¡å¼');
        const result = await generateIntelligentPhoto(
          imagePrompt, 
          inputs.filterStyle,
          false, // è™šæ‹Ÿé£æ ¼
          inputs.uploadedImageBase64,
          inputs.uploadedImageMimeType
        );
        
        return {
          imageBase64: result.imageBase64,
          promptUsed: result.promptUsed,
          apiProvider: result.apiProvider as ImageApiProvider,
          sceneName: scenario.coreScenes[0].name,
          filterApplied: inputs.filterStyle,
          fictionalPlace: scenario.destinationName
        };
      }

    } else {
      // çœŸå®æ—…è¡Œæ¨¡å¼
      console.log('ğŸ—ºï¸ ç”ŸæˆçœŸå®æ—…è¡Œè®¡åˆ’...');
      const itinerary = await generateRealisticTravelItinerary(inputs);
      setGeneratedItinerary(itinerary);

      const primaryActivity = itinerary.dailyPlans[0]?.activities[0] || null;
      
      // ç”Ÿæˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆ
      console.log('ğŸ“± ç”Ÿæˆç¤¾äº¤åª’ä½“æ–‡æ¡ˆ...');
      const socialMediaCopy = await generateRealisticSocialMediaCopy(itinerary, primaryActivity);
      setGeneratedSocialMediaCopy(socialMediaCopy);

      // ç”Ÿæˆè§†é¢‘è„šæœ¬
      console.log('ğŸ¬ ç”Ÿæˆè§†é¢‘è„šæœ¬...');
      const videoScript = await generateRealisticVideoScript(
        itinerary,
        primaryActivity,
        inputs.duration,
        inputs.uploadedImageBase64,
        inputs.uploadedImageMimeType
      );
      setGeneratedVideoScript(videoScript);

      // ç”Ÿæˆè¯„è®º
      console.log('ğŸ’¬ ç”Ÿæˆè¯„è®º...');
      const comments = await generateRealisticFakeComments(itinerary, primaryActivity);
      const formattedComments: FakeComment[] = comments.map((comment, index) => ({
        id: `comment-${index}`,
        userName: `${DEFAULT_USER_NAME}${index + 1}`,
        content: comment,
        timestamp: new Date(Date.now() - Math.random() * 86400000).toISOString()
      }));
      setFakeComments(formattedComments);

      // ç”Ÿæˆå›¾ç‰‡ - ä½¿ç”¨å†…ç½®å…è´¹æœåŠ¡
      console.log('ğŸ¨ ç”Ÿæˆå›¾ç‰‡...');
      const imagePrompt = `${itinerary.destinationName}çœŸå®æ—…è¡Œåœºæ™¯ï¼Œ${inputs.theme}ä¸»é¢˜ï¼ŒçœŸå®æ‘„å½±é£æ ¼`;
      
      // ğŸ¯ é‡è¦ä¿®å¤ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸Šä¼ äº†å›¾ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨å›¾ç”Ÿå›¾æ¨¡å¼
      const hasUploadedImage = !!inputs.uploadedImageBase64;
      console.log(`ğŸ–¼ï¸ ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡æ£€æŸ¥: ${hasUploadedImage ? 'âœ… æœ‰ä¸Šä¼ ' : 'âŒ æ— ä¸Šä¼ '}`);
      
      if (hasUploadedImage && inputs.uploadedImageBase64) {
        console.log('ğŸ­ å¯ç”¨å›¾ç”Ÿå›¾æ¨¡å¼ï¼šåŸºäºç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ç”ŸæˆçœŸå®æ—…è¡Œåœºæ™¯');
        console.log('ğŸ“ ä¸Šä¼ å›¾ç‰‡æ•°æ®é•¿åº¦:', inputs.uploadedImageBase64.length);
        console.log('ğŸ“„ å›¾ç‰‡ç±»å‹:', inputs.uploadedImageMimeType || 'unknown');
        
        // ä¸ºå›¾ç”Ÿå›¾å¢å¼ºæç¤ºè¯
        const enhancedImagePrompt = `åŸºäºç”¨æˆ·ä¸Šä¼ çš„ä¸ªäººç…§ç‰‡ï¼Œå°†å…¶èå…¥${itinerary.destinationName}çš„çœŸå®æ—…è¡Œåœºæ™¯ã€‚ä¿æŒäººç‰©ç‰¹å¾ï¼Œå±•ç°åœ¨${inputs.theme}ä¸»é¢˜ä¸‹çš„æ—…è¡Œä½“éªŒã€‚${imagePrompt}`;
        
        const result = await generateIntelligentPhoto(
          enhancedImagePrompt, 
          inputs.filterStyle,
          true, // çœŸå®é£æ ¼
          inputs.uploadedImageBase64,
          inputs.uploadedImageMimeType
        );
        
        setGeneratedImageData({
          imageBase64: result.imageBase64,
          promptUsed: result.promptUsed,
          apiProvider: result.apiProvider as ImageApiProvider,
          sceneName: primaryActivity?.name,
          filterApplied: inputs.filterStyle,
          realPlaceContext: itinerary.destinationName,
          userName: 'æ‚¨çš„æ—…è¡Œèº«å½±'
        });
      } else {
        console.log('ğŸ“ ä½¿ç”¨æ ‡å‡†æ–‡ç”Ÿå›¾æ¨¡å¼');
        const result = await generateIntelligentPhoto(
          imagePrompt, 
          inputs.filterStyle,
          true, // çœŸå®é£æ ¼
          inputs.uploadedImageBase64,
          inputs.uploadedImageMimeType
        );
        
        setGeneratedImageData({
          imageBase64: result.imageBase64,
          promptUsed: result.promptUsed,
          apiProvider: result.apiProvider as ImageApiProvider,
          sceneName: primaryActivity?.name,
          filterApplied: inputs.filterStyle,
          realPlaceContext: itinerary.destinationName
        });
      }
    }

    console.log('âœ… Gemini APIç”Ÿæˆå®Œæˆï¼');
  };

  // å•å¼ å›¾ç‰‡åˆ·æ–°ï¼ˆé‡ç”Ÿæˆï¼‰é€»è¾‘
  const handleRetryImage = async (index: number) => {
    if (!userInputs) return;
    setRefreshError(prev => prev.map((e, i) => i === index ? '' : e));
    setRefreshingIndexes(prev => [...prev, index]);
    let newImageData: GeneratedImageData | undefined;
    try {
      const randomSeed = Date.now() + Math.floor(Math.random() * 100000);
      const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('å›¾ç‰‡ç”Ÿæˆè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•')), 30000));
      const generatePromise = (async () => {
        if (userInputs.travelMode === 'realistic' && generatedItinerary) {
          const dayPlans = generatedItinerary.dailyPlans || [];
          let activity;
          let count = 0;
          outer: for (const day of dayPlans) {
            for (const act of day.activities) {
              if (count === index) { activity = act; break outer; }
              count++;
            }
          }
          if (!activity) throw new Error('æœªæ‰¾åˆ°å¯¹åº”æ´»åŠ¨');
          const prompt = `${activity.name}åœ¨${generatedItinerary.destinationName}ï¼Œ${activity.description}ï¼ŒçœŸå®æ—…è¡Œæ‘„å½±é£æ ¼ï¼Œè‡ªç„¶å…‰çº¿ï¼ŒçœŸå®åœºæ™¯ï¼Œä¸“ä¸šæ‘„å½±è´¨é‡ï¼Œç”Ÿæ´»åŒ–åœºæ™¯ï¼Œæ—…è¡Œçºªå®æ‘„å½±ï¼Œæ— ä»»ä½•æ–‡å­—ï¼Œæ— æ°´å°ï¼Œçº¯å‡€ç”»é¢`;
          const result = await generateIntelligentPhoto(prompt, userInputs.filterStyle, true);
          newImageData = {
            src: result.imageBase64,
            imageBase64: result.imageBase64,
            sceneName: activity.name,
            userName: 'æ—…è¡Œè¾¾äºº',
            realPlaceContext: `${generatedItinerary.destinationName} - ${activity.addressOrArea}`,
            filterApplied: userInputs.filterStyle,
            promptUsed: result.promptUsed,
            apiProvider: result.apiProvider as ImageApiProvider
          };
        } else if (userInputs.travelMode === 'fictional' && generatedScenario) {
          // é‡æ–°ç”Ÿæˆè„šæœ¬ï¼Œç¡®ä¿åˆ†é•œå’Œpromptæœ‰å˜åŒ–
          const videoScript = await generateIntelligentVideoScript(
            generatedScenario,
            null,
            userInputs,
            randomSeed
          );
          const scene = videoScript.scenes[index];
          if (!scene) throw new Error('æœªæ‰¾åˆ°å¯¹åº”åˆ†é•œ');
          const prompt = `${userInputs.theme}é£æ ¼çš„${scene.shot}`;
          const result = await generateIntelligentPhoto(prompt, userInputs.filterStyle, false);
          newImageData = {
            src: result.imageBase64,
            imageBase64: result.imageBase64,
            sceneName: generatedScenario.coreScenes[index]?.name || `åˆ†é•œ${index+1}`,
            userName: 'å¹»å¢ƒæ¢ç´¢è€…',
            fictionalPlace: generatedScenario.destinationName,
            filterApplied: userInputs.filterStyle,
            promptUsed: result.promptUsed,
            apiProvider: result.apiProvider as ImageApiProvider
          };
        } else {
          throw new Error('æœªçŸ¥çš„æ—…è¡Œæ¨¡å¼');
        }
        setGeneratedImagesList(prev => prev.map((img, i) => i === index ? (newImageData as GeneratedImageData) : img));
        setRefreshError(prev => prev.map((e, i) => i === index ? '' : e));
      })();
      await Promise.race([generatePromise, timeoutPromise]);
    } catch (err: any) {
      setRefreshError(prev => {
        const arr = [...prev];
        arr[index] = `å›¾ç‰‡åˆ·æ–°å¤±è´¥ï¼š${err.message || err}`;
        return arr;
      });
    } finally {
      setRefreshingIndexes(prev => prev.filter(i => i !== index));
    }
  };

  // æ¸²æŸ“ä¸åŒé˜¶æ®µçš„å†…å®¹
  const renderCurrentPhase = () => {
    // åªæ¸²æŸ“åŠŸèƒ½é€‰æ‹©é¡µé¢
    return renderFunctionSelectionPage();
  };

  // æ¸²æŸ“åŠŸèƒ½é€‰æ‹©é¡µé¢
  const renderFunctionSelectionPage = () => {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-indigo-900 relative overflow-hidden">
        {/* åŠ¨æ€èƒŒæ™¯è£…é¥°å…ƒç´  */}
        <div className="absolute inset-0 overflow-hidden pointer-events-none">
          {/* ä¸»è¦åŠ¨æ€æ¸å˜èƒŒæ™¯ */}
          <div className="absolute inset-0 bg-gradient-to-r from-purple-600/30 via-blue-600/20 to-cyan-600/30 animate-pulse"></div>
          
          {/* æµ®åŠ¨ç²’å­å’Œè£…é¥°å…ƒç´  */}
          <div className="absolute top-10 left-10 w-4 h-4 bg-cyan-400 rounded-full animate-ping opacity-40"></div>
          <div className="absolute top-20 right-20 w-6 h-6 bg-purple-400 rounded-full animate-bounce opacity-50 delay-300"></div>
          <div className="absolute bottom-20 left-20 w-3 h-3 bg-pink-400 rounded-full animate-pulse opacity-60 delay-500"></div>
          <div className="absolute bottom-32 right-32 w-5 h-5 bg-blue-400 rounded-full animate-ping opacity-40 delay-700"></div>
          <div className="absolute top-1/3 left-1/4 w-2 h-2 bg-yellow-400 rounded-full animate-bounce opacity-50 delay-1000"></div>
          <div className="absolute top-2/3 right-1/4 w-3 h-3 bg-green-400 rounded-full animate-pulse opacity-60 delay-1200"></div>
          
          {/* å¤§å‹è£…é¥°åœ†åœˆ */}
          <div className="absolute -top-20 -left-20 w-80 h-80 bg-gradient-to-br from-purple-500/20 to-blue-500/20 rounded-full blur-3xl animate-pulse"></div>
          <div className="absolute -bottom-20 -right-20 w-96 h-96 bg-gradient-to-tl from-cyan-500/20 to-purple-500/20 rounded-full blur-3xl animate-pulse delay-1000"></div>
          <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-gradient-to-r from-pink-500/15 to-yellow-500/15 rounded-full blur-3xl animate-spin" style={{animationDuration: '20s'}}></div>
          
          {/* æµåŠ¨çš„å…‰çº¿æ•ˆæœ */}
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-400/60 to-transparent animate-pulse"></div>
          <div className="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-purple-400/60 to-transparent animate-pulse delay-500"></div>
          <div className="absolute left-0 top-0 w-1 h-full bg-gradient-to-b from-transparent via-pink-400/60 to-transparent animate-pulse delay-300"></div>
          <div className="absolute right-0 top-0 w-1 h-full bg-gradient-to-b from-transparent via-blue-400/60 to-transparent animate-pulse delay-700"></div>
          
          {/* æ˜Ÿæ˜Ÿæ•ˆæœ */}
          <div className="absolute top-16 left-1/3 w-1 h-1 bg-white rounded-full animate-ping opacity-70 delay-200"></div>
          <div className="absolute top-24 right-1/3 w-1 h-1 bg-white rounded-full animate-ping opacity-70 delay-400"></div>
          <div className="absolute bottom-16 left-2/3 w-1 h-1 bg-white rounded-full animate-ping opacity-70 delay-600"></div>
          <div className="absolute bottom-24 right-2/3 w-1 h-1 bg-white rounded-full animate-ping opacity-70 delay-800"></div>
          
          {/* æ¼‚æµ®çš„å‡ ä½•å½¢çŠ¶ */}
          <div className="absolute top-32 left-16 w-8 h-8 border-2 border-cyan-400/40 rotate-45 animate-spin opacity-60" style={{animationDuration: '8s'}}></div>
          <div className="absolute bottom-32 right-16 w-6 h-6 border-2 border-purple-400/40 rotate-12 animate-bounce opacity-50"></div>
          <div className="absolute top-1/2 right-8 w-4 h-8 bg-gradient-to-b from-pink-400/30 to-transparent rotate-12 animate-pulse delay-300"></div>
          <div className="absolute bottom-1/3 left-8 w-8 h-4 bg-gradient-to-r from-blue-400/30 to-transparent rotate-45 animate-pulse delay-600"></div>
        </div>

        <div className="relative z-20">
          {/* åº”ç”¨å¤´éƒ¨ */}
          <header className="relative z-50 border-b border-slate-600/50 backdrop-blur-xl bg-slate-900/70">
            <div className="container mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                
                {/* å“ç‰ŒLogoå’Œæ ‡é¢˜ */}
                <div className="flex items-center space-x-4">
                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 via-purple-600 to-cyan-500 flex items-center justify-center shadow-lg">
                    <span className="text-white font-bold text-lg">ğŸŒŸ</span>
                  </div>
                  <div>
                    <h1 className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">
                      å¹»å¢ƒä¹‹æ—…ç”Ÿæˆå™¨
                    </h1>
                    <p className="text-xs text-slate-400">AIé©±åŠ¨çš„æ—…è¡Œå†…å®¹åˆ›ä½œå·¥å…· - è™šæ‹Ÿç´ æç”Ÿæˆ</p>
                  </div>
                </div>

                {/* å³ä¾§æŒ‰é’®ç»„ */}
                <div className="flex items-center space-x-3">
                  {/* APIé…ç½®æŒ‰é’® */}
                  <button
                    onClick={() => setShowApiConfigModal(true)}
                    className="flex items-center space-x-2 px-3 py-2 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/50 hover:border-slate-500/50 rounded-lg transition-all duration-200 text-slate-300 hover:text-white"
                    title="é…ç½®APIæœåŠ¡"
                  >
                    <Settings className="w-4 h-4" />
                    <span className="hidden sm:inline text-sm">APIé…ç½®</span>
                  </button>

                  {/* åœ°å›¾æŒ‡å—æŒ‰é’® */}
                  <button
                    onClick={() => setShowMapGuide(true)}
                    className="flex items-center space-x-2 px-3 py-2 bg-blue-800/50 hover:bg-blue-700/50 border border-blue-600/50 hover:border-blue-500/50 rounded-lg transition-all duration-200 text-blue-300 hover:text-white"
                    title="æŸ¥çœ‹åœ°å›¾åŠŸèƒ½æŒ‡å—"
                  >
                    <Map className="w-4 h-4" />
                    <span className="hidden sm:inline text-sm">åœ°å›¾æŒ‡å—</span>
                  </button>

                  {/* ç”¨æˆ·æŒ‰é’® */}
                  <button
                    onClick={() => setShowUserPanel(true)}
                    className="flex items-center space-x-3 px-4 py-2 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/50 hover:border-slate-500/50 rounded-lg transition-all duration-200 text-slate-300 hover:text-white"
                    title={currentUser ? `${currentUser.profile?.nickname || currentUser.username || 'ç”¨æˆ·'} - å‰©ä½™${usageInfo.remainingToday}æ¬¡` : 'ç™»å½•/æ³¨å†Œ - æ¸¸å®¢æ¨¡å¼'}
                  >
                    <div className="flex items-center space-x-2">
                      <UserIcon className="w-5 h-5" />
                      <div className="text-left">
                        <div className="text-sm font-medium">
                          {currentUser ? (currentUser.profile?.nickname || currentUser.username || 'ç”¨æˆ·') : 'æ¸¸å®¢æ¨¡å¼'}
                        </div>
                        <div className="text-xs text-slate-400">
                          å‰©ä½™ {usageInfo.remainingToday} æ¬¡
                        </div>
                      </div>
                      {currentUser && (
                        <div className={`w-2 h-2 rounded-full ${
                          currentUser.tier === 'guest' ? 'bg-gray-400' :
                          currentUser.tier === 'free' ? 'bg-blue-400' :
                          currentUser.tier === 'premium' ? 'bg-purple-400' :
                          'bg-yellow-400'
                        }`} />
                      )}
                    </div>
                  </button>

                  {/* é€€å‡ºæŒ‰é’® */}
                  <button
                    onClick={handleExitApp}
                    className="flex items-center space-x-2 px-3 py-2 bg-red-800/50 hover:bg-red-700/50 border border-red-600/50 hover:border-red-500/50 rounded-lg transition-all duration-200 text-red-300 hover:text-white"
                    title="é€€å‡ºåº”ç”¨"
                  >
                    <LogOut className="w-4 h-4" />
                    <span className="hidden sm:inline text-sm">é€€å‡º</span>
                  </button>
                </div>
              </div>
            </div>
          </header>
          
          <main className="container mx-auto px-4 py-8 min-h-screen">
            <div className="flex flex-col items-center justify-center min-h-[80vh] text-center">
              <div className="max-w-4xl mx-auto mb-8">
                <h1 className="text-4xl md:text-6xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-cyan-400">
                  é€‰æ‹©æ‚¨çš„å†…å®¹ç”Ÿæˆç±»å‹
                </h1>
                <p className="text-xl text-slate-300 mb-12">
                  AIé©±åŠ¨çš„æ—…è¡Œå†…å®¹åˆ›ä½œå·¥å…·ï¼Œç”Ÿæˆä¸åŒé£æ ¼çš„è™šæ‹Ÿæ—…è¡Œä½“éªŒå†…å®¹
                </p>
                
                {/* åŠŸèƒ½é€‰æ‹©å¡ç‰‡ */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div 
                    onClick={() => handleFunctionSelect('virtual')}
                    className="bg-gradient-to-br from-purple-600/20 to-blue-600/20 backdrop-blur-sm rounded-2xl p-8 border border-purple-400/30 hover:scale-105 transition-all duration-300 cursor-pointer group relative overflow-hidden"
                  >
                    {/* å¡ç‰‡å†…éƒ¨åŠ¨æ€è£…é¥° */}
                    <div className="absolute inset-0 bg-gradient-to-r from-purple-500/10 via-transparent to-blue-500/10 animate-pulse"></div>
                    <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-cyan-400/20 to-transparent rounded-full -translate-y-16 translate-x-16 group-hover:scale-150 transition-transform duration-500"></div>
                    <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-purple-400/20 to-transparent rounded-full translate-y-12 -translate-x-12 group-hover:scale-150 transition-transform duration-500"></div>
                    
                    <div className="relative z-10">
                      <div className="text-6xl mb-6 group-hover:animate-bounce group-hover:scale-110 transition-all duration-300">ğŸŒŒ</div>
                      <h3 className="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-cyan-300 group-hover:from-purple-200 group-hover:to-cyan-200 transition-all duration-300">è™šæ‹Ÿå¹»å¢ƒå†…å®¹</h3>
                      <p className="text-slate-300 mb-6 group-hover:text-slate-200 transition-colors duration-300">AIåˆ›é€ çš„å¥‡å¹»ä¸–ç•Œæ—…è¡Œå†…å®¹ç”Ÿæˆï¼Œæ‰“é€ å‰æ‰€æœªæœ‰çš„è™šæ‹Ÿä»™å¢ƒæ•…äº‹ç´ æ</p>
                      <div className="flex items-center text-cyan-400 group-hover:text-cyan-300 transition-colors duration-300">
                        <span className="font-semibold">æ¢ç´¢ç¥ç§˜ä»™å¢ƒ</span>
                        <span className="ml-2 group-hover:translate-x-2 transition-transform duration-300">â†’</span>
                      </div>
                    </div>
                  </div>
                  
                  <div 
                    onClick={() => handleFunctionSelect('real')}
                    className="bg-gradient-to-br from-green-600/20 to-cyan-600/20 backdrop-blur-sm rounded-2xl p-8 border border-cyan-400/30 hover:scale-105 transition-all duration-300 cursor-pointer group relative overflow-hidden"
                  >
                    {/* å¡ç‰‡å†…éƒ¨åŠ¨æ€è£…é¥° */}
                    <div className="absolute inset-0 bg-gradient-to-r from-green-500/10 via-transparent to-cyan-500/10 animate-pulse delay-500"></div>
                    <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-green-400/20 to-transparent rounded-full -translate-y-16 translate-x-16 group-hover:scale-150 transition-transform duration-500"></div>
                    <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-cyan-400/20 to-transparent rounded-full translate-y-12 -translate-x-12 group-hover:scale-150 transition-transform duration-500"></div>
                    
                    <div className="relative z-10">
                      <div className="text-6xl mb-6 group-hover:animate-bounce group-hover:scale-110 transition-all duration-300">ğŸŒ</div>
                      <h3 className="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-cyan-300 group-hover:from-green-200 group-hover:to-cyan-200 transition-all duration-300">ä»¿çœŸæ—…è¡Œå†…å®¹</h3>
                      <p className="text-slate-300 mb-6 group-hover:text-slate-200 transition-colors duration-300">AIæ™ºèƒ½ç”Ÿæˆä»¿çœŸæ—…è¡Œè§„åˆ’å†…å®¹ï¼Œåˆ›ä½œæ¨¡æ‹ŸçœŸå®åŸå¸‚çš„è¡Œç¨‹ç´ æå’Œæ”»ç•¥æ–‡æ¡ˆ</p>
                      <div className="flex items-center text-cyan-400 group-hover:text-cyan-300 transition-colors duration-300">
                        <span className="font-semibold">å¼€å§‹æ¢¦æƒ³ä¹‹æ—…</span>
                        <span className="ml-2 group-hover:translate-x-2 transition-transform duration-300">â†’</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </main>
          
          <Footer />
        </div>
        
        {/* æ¨¡æ€æ¡† */}
        <SettingsModal
          isOpen={showSettingsModal}
          onClose={() => setShowSettingsModal(false)}
        />

        <FreeApiPanel
          isOpen={showFreeApiPanel}
          onClose={() => setShowFreeApiPanel(false)}
        />

        <ApiConfigModal
          isOpen={showApiConfigModal}
          onClose={() => setShowApiConfigModal(false)}
          currentConfig={apiConfig}
          onSave={saveApiConfig}
        />

        {/* åœ°å›¾åŠŸèƒ½æŒ‡å—æ¨¡æ€æ¡† */}
        {showMapGuide && (
          <MapGuide
            onClose={() => setShowMapGuide(false)}
          />
        )}

        {/* ç”¨æˆ·ä¸­å¿ƒé¢æ¿ */}
        {showUserPanel && (
          <UserPanel
            onClose={() => {
              setShowUserPanel(false);
              handleUserChange(); // å…³é—­æ—¶åˆ·æ–°ç”¨æˆ·çŠ¶æ€
            }}
          />
        )}

        {/* é…ç½®æ¨¡æ€æ¡† - æ ¹æ®é€‰æ‹©çš„æ¨¡å¼æ˜¾ç¤º */}
        {selectedTravelMode && (
          <InitialModal
            isOpen={showInitialModal}
            onClose={() => {
              setShowInitialModal(false);
              setSelectedTravelMode(null);
            }}
            travelMode={selectedTravelMode}
            onSubmit={(inputs) => {
              const updatedInputs = { ...inputs, travelMode: selectedTravelMode };
              handleInputSubmit(updatedInputs);
            }}
            onExit={handleExitApp}
          />
        )}

        {/* ä¸»è¦å†…å®¹åŒºåŸŸ - å¦‚æœæœ‰ç”Ÿæˆçš„å†…å®¹åˆ™æ˜¾ç¤º */}
        {!isLoading && !error && (userInputs || generatedScenario || generatedItinerary) && userInputs && (
          <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-50 overflow-auto">
            <div className="container mx-auto px-4 py-8">
              {/* è¿”å›æŒ‰é’® */}
              <div className="mb-6">
                <button
                  onClick={handleBackToFunctionSelection}
                  className="flex items-center space-x-2 text-slate-300 hover:text-white transition-colors duration-200"
                >
                  <span>â†</span>
                  <span>è¿”å›é€‰æ‹©é¡µé¢</span>
                </button>
              </div>

              {/* ç»“æœæ˜¾ç¤º */}
              <ResultsDisplay
                userInputs={userInputs}
                scenario={generatedScenario}
                realisticItinerary={generatedItinerary}
                socialMediaCopy={generatedSocialMediaCopy}
                videoScript={generatedVideoScript}
                generatedImages={generatedImagesList}
                fakeEngagement={fakeEngagementData}
                fakeComments={fakeComments}
                travelReflectionCards={travelReflectionCards}
                onReset={handleReset}
                onBackToHome={handleBackToHome}
                onBackToSetup={handleBackToSetup}
                onExit={handleExitApp}
                onRetryImage={handleRetryImage}
                refreshError={refreshError}
              />
            </div>
          </div>
        )}

        {/* åŠ è½½çŠ¶æ€ */}
        {isLoading && (
          <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-50 flex items-center justify-center">
            <LoadingSpinner
              currentStep={currentGenerationStep}
              currentStepIndex={currentStepIndex}
              totalSteps={totalGenerationSteps}
              isVirtual={userInputs?.travelMode === 'fictional'}
            />
          </div>
        )}

        {/* é”™è¯¯çŠ¶æ€ */}
        {error && (
          <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="max-w-md bg-red-900/50 border border-red-500/50 rounded-xl p-6 text-center">
              <h3 className="text-red-300 font-semibold mb-2">âŒ ç”Ÿæˆå¤±è´¥</h3>
              <p className="text-red-200 mb-4">{error}</p>
              <button
                onClick={handleReset}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors duration-200"
              >
                é‡æ–°å¼€å§‹
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // å¦‚æœæœ‰åº”ç”¨çº§åˆ«é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯é¡µé¢
  if (appError) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="max-w-md bg-red-900/50 border border-red-500/50 rounded-xl p-6 text-center">
          <h2 className="text-red-300 text-xl font-semibold mb-4">åº”ç”¨å¯åŠ¨é”™è¯¯</h2>
          <p className="text-red-200 mb-4">{appError}</p>
          <button
            onClick={() => {
              setAppError(null);
              localStorage.removeItem('travel-generator-api-config');
              window.location.reload();
            }}
            className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
          >
            æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½
          </button>
        </div>
      </div>
    );
  }

  // ä¸»æ¸²æŸ“
  return renderCurrentPhase();
};

export default App; 